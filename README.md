Docker containers for QWC Services
==================================

This repository contains a sample setup for running QWC services with docker.


Quick start
-----------

Install docker and docker compose:

* Docker: https://docs.docker.com/engine/install/
* docker-compose: (https://docs.docker.com/compose/install/)

Clone qwc-docker and copy docker-compose template

    git clone https://github.com/qwc-services/qwc-docker.git
    cd qwc-docker
    cp docker-compose-example.yml docker-compose.yml

Create a secret key:

    python3 -c 'import secrets; print("JWT_SECRET_KEY=\"%s\"" % secrets.token_hex(48))' >.env

Set permissions for writable volumes:

    sudo chown -R www-data:www-data volumes/attachments
    sudo chown -R www-data:www-data volumes/config
    sudo chown -R www-data:www-data volumes/qgs-resources
    sudo chown -R www-data:www-data volumes/qwc2/assets

    sudo chown 8983:8983 volumes/solr/data

Start all containers:

    docker-compose up -d

Follow log output:

    docker-compose logs -f

Open map viewer:

    http://localhost:8088/

Open Admin GUI (Default admin credentials: username `admin`, password `admin`, requires password change on first login):

    http://localhost:8088/qwc_admin

Conntect to DB:

    psql "service=qwc_configdb" # Config DB
    psql "service=qwc_geodb" # Demo data DB

 * See [pg_service.conf](https://github.com/qwc-services/qwc-docker/blob/master/pg_service.conf)

Demo DB superuser password (please change for production use!):

* See `POSTGRES_PASSWORD` in [https://github.com/qwc-services/qwc-demo-db/blob/main/Dockerfile](https://github.com/qwc-services/qwc-demo-db/blob/main/Dockerfile)

Stop all containers:

    docker-compose down

Update containers:

* Change image tag for desired container in `docker-compose.yml`
* Run `docker-compose-pull <container name>`


Architecture overview
---------------------

![qwc-services-arch](https://github.com/qwc-services/qwc-services-core/raw/master/doc/qwc-services-arch.png)

* `API-Gateway`: API Gateway, forwards requests to individual services (http://localhost:8088)
* `Auth-Service`: Authentication service with local user database (default users: `admin:admin`, `demo:demo`) (http://localhost:8088/auth/login)
* `Map viewer`: QWC2 map viewer (http://localhost:8088)
* `OGC Service`: Proxy for WMS/WFS requests filtered by permissions, calls QGIS Server (http://localhost:8088/ows/api)
* `Admin GUI`: Admin GUI (http://localhost:8088/qwc_admin/)

Component overview
------------------

Applications:
* [QWC2 Map Viewer](https://github.com/qwc-services/qwc-map-viewer): The map viewer application
* [QWC admin GUI](https://github.com/qwc-services/qwc-admin-gui): Configuration backend for managing users and permissions
* [Registration GUI](https://github.com/qwc-services/qwc-registration-gui): GUI for registration of new users

REST services:
* [DB auth service](https://github.com/qwc-services/qwc-db-auth): Authentication service with local user database
* [LDAP auth service](https://github.com/qwc-services/qwc-ldap-auth): LDAP Authentication service
* [Data service](https://github.com/qwc-services/qwc-data-service): Data edit service, required for QWC2 editing functionality
* [Document service](https://github.com/qwc-services/qwc-document-service): Service for generating Jasper reports
* [Elevation service](https://github.com/qwc-services/qwc-elevation-service): Service for providing elevation data, required for QWC2 elevation profile
* [Feature info service](https://github.com/qwc-services/qwc-feature-info-service): Service for providing enhanced GetFeatureInfo responses to QWC2
* [Fulltext search service](https://github.com/qwc-services/qwc-fulltext-search-service): Fulltext search service for the QWC2 search functionality
* [Legend service](https://github.com/qwc-services/qwc-legend-service): Service for providing enhanced legend graphics to QWC2
* [Mapinfo service](https://github.com/qwc-services/qwc-mapinfo-service): Service for providing additional information to the QWC2 right-click map context popup
* [OGC service](https://github.com/qwc-services/qwc-ogc-service): Proxy for WMS/WFS requests filtered by permissions, calls QGIS Server
* [Permalink service](https://github.com/qwc-services/qwc-permalink-service): Service for storing compat permalinks and bookmarks generated by QWC2
* [Print service](https://github.com/qwc-services/qwc-print-service): Service for enhancing the QWC2 GetPrint requests

Configuration database:
* [DB schema and migrations](https://github.com/qwc-services/qwc-config-db)
* [Demo database](https://github.com/qwc-services/qwc-demo-db-db)

Configuration generator:
* [Configuration generator](https://github.com/qwc-services/qwc-config-generator)


Overview which container accesses which volume
----------------------------------------------

An overview of how each container accesses which volume
can be found [here](docker-volume-matrix.md).


Health checks for Kubernetes
----------------------------

Health checks are a simple way to let the system know if an instance of the app is working or not working. If an instance of the app is not working, then other services should not access it or send a request to it. Instead, requests should be sent to another instance of the app that is ready, or retried at a later time. The system should also bring the app back to a healthy state.

### Readyness:

Readiness probes are designed to let Kubernetes know when the app is ready to serve traffic. Kubernetes makes sure the readiness probe passes before allowing a service to send traffic to the pod. If a readiness probe starts to fail, Kubernetes stops sending traffic to the pod until it passes.

**Check is available at: /ready**

Example check:

* Return ok, if web service is initialized and running

### Liveness:

**Check is available at: /healthz**

Liveness probes let Kubernetes know if the app is alive or dead. If the app is alive, then Kubernetes leaves it alone. If the app is dead, Kubernetes removes the Pod and starts a new one to replace it.

Example checks:

* Check database connection (Example service: qwc-admin-gui)
* Check if all data files are available and readable (Example service: qwc-elevation-service)
